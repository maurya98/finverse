generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum HttpMethod {
    GET
    POST
    PUT
    PATCH
    DELETE
}

enum PermissionScope {
    READ
    WRITE
    FULL
}

/**
 * Internal microservices
 */
model Service {
    id        String   @id @default(uuid())
    name      String   @unique
    baseUrl   String
    createdAt DateTime @default(now())

    routes ServiceRoute[]
}

/**
 * Routes exposed through gateway
 */
model ServiceRoute {
    id        String  @id @default(uuid())
    serviceId String
    service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

    name        String // e.g. "Get User Profile"
    method      HttpMethod
    actualPath  String // actual service path
    exposedPath String // exposed path

    createdAt DateTime @default(now())

    permissions ClientPermission[]

    @@unique([serviceId, method, actualPath])
    @@unique([method, exposedPath])
}

/**
 * External client applications
 */
model ClientApp {
    id        String   @id @default(uuid())
    name      String   @unique
    secret    String // hashed secret
    createdAt DateTime @default(now())

    permissions ClientPermission[]
}

/**
 * Which client can access which route
 */
model ClientPermission {
    id       String @id @default(uuid())
    clientId String
    routeId  String

    client ClientApp    @relation(fields: [clientId], references: [id], onDelete: Cascade)
    route  ServiceRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

    scope PermissionScope @default(FULL)

    @@unique([clientId, routeId])
}
